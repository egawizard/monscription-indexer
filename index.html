<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monscription Indexer — Public (Final)</title>
  <meta name="description" content="Public real-time indexer frontend for Monscription (Monad Testnet). Configure BACKEND to point to your deployed indexer server." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='46' fill='%230af'%3E%3C/circle%3E%3Ctext x='50' y='58' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3EM%3C/text%3E%3C/svg%3E" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.456.0/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>

  <style>
    :root{color-scheme:dark}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;margin:0}
    .glass{background:rgba(13,17,23,.6);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.06)}
    .card{border-radius:1rem}
    .small-muted{color:#9CA3AF}
    .status-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:8px}
    .table-fixed{table-layout:fixed}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-950 to-black text-slate-200">
  <header class="p-4 bg-black/40 border-b border-white/5">
    <div class="max-w-6xl mx-auto flex items-center gap-4">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-indigo-500 to-cyan-400 grid place-items-center font-black">M</div>
      <div>
        <div class="text-lg font-bold">Monscription Indexer — Public</div>
        <div class="text-sm small-muted">Realtime indexer for Monscription on Monad Testnet</div>
      </div>
      <div class="ml-auto text-xs small-muted">Created by <a class="underline" href="https://x.com/ega_2ez4crypto" target="_blank">@ega_2ez4crypto</a></div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6 grid md:grid-cols-3 gap-6">
    <section class="md:col-span-2 card glass p-4">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-semibold">Tokens (server)</h2>
          <div class="text-xs small-muted">Data diambil dari backend indexer. Pastikan server sudah dideploy dan variabel <code>BACKEND</code> sudah diubah.</div>
        </div>
        <div class="flex items-center gap-3">
          <div id="serverStatus" class="text-xs small-muted flex items-center gap-2"><span id="statusDot" class="status-dot bg-yellow-500"></span><span id="statusText">Connecting…</span></div>
          <button id="refreshBtn" class="px-3 py-1 bg-white/6 rounded">Refresh</button>
          <button id="clearCache" class="px-3 py-1 bg-red-700/10 rounded">Clear Cache</button>
        </div>
      </div>

      <div id="tokensWrap" class="space-y-3">
        <div id="tokensLoading" class="text-slate-400">Memuat…</div>
        <div class="overflow-auto rounded-md bg-black/10 p-2">
          <table id="tokensTable" class="hidden w-full text-sm table-fixed">
            <thead class="text-slate-400 text-xs text-left"><tr><th class="w-36 p-2">Tick</th><th class="p-2">Max</th><th class="p-2">Minted</th><th class="p-2">Holders</th><th class="p-2">Deployer</th></tr></thead>
            <tbody id="tokensTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <aside class="card glass p-4">
      <h3 class="font-semibold">Live Inscribe</h3>
      <div id="inscribes" class="mt-3 text-sm text-slate-300 max-h-[420px] overflow-auto"></div>
    </aside>
  </main>

  <footer class="max-w-6xl mx-auto p-4 text-xs text-slate-500">© <span id="year"></span> Monscription Indexer • created by https://x.com/ega_2ez4crypto</footer>

  <script>
    // ===== CONFIG =====
    // Set BACKEND to your deployed server origin (no trailing /api). Example:
    //  const BACKEND = 'https://mons-indexer.onrender.com';
    // If you want to use the same origin where this frontend is hosted, set BACKEND = 'auto'.
    const BACKEND = 'auto'; // <-- REPLACE with your server origin or keep 'auto' for same-origin

    function backendOrigin(){
      if (BACKEND === 'auto') return window.location.origin;
      return BACKEND.replace(/\/$/, '');
    }

    const API_BASE = backendOrigin() + '/api';
    const WS_BASE = (function(){
      const origin = backendOrigin();
      if (origin.startsWith('https://')) return 'wss://' + origin.replace(/^https:\/\//, '');
      if (origin.startsWith('http://')) return 'ws://' + origin.replace(/^http:\/\//, '');
      return origin;
    })();

    document.getElementById('year').textContent = new Date().getFullYear();

    // local cache helpers
    function cacheSet(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
    function cacheGet(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch(e){ return null } }

    // UI helpers
    function setServerStatus(ok, text){
      const dot = document.getElementById('statusDot');
      const t = document.getElementById('statusText');
      if (ok){ dot.style.backgroundColor = '#16A34A'; } else { dot.style.backgroundColor = '#F59E0B'; }
      t.textContent = text;
    }

    async function fetchJSON(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    async function fetchTokens(){
      const loading = document.getElementById('tokensLoading');
      const table = document.getElementById('tokensTable');
      const tbody = document.getElementById('tokensTbody');
      loading.style.display = 'block'; table.classList.add('hidden');
      try{
        const data = await fetchJSON(API_BASE + '/tokens');
        cacheSet('mons_tokens', data);
        renderTokens(data);
        setServerStatus(true, 'Connected to ' + backendOrigin());
      }catch(e){
        console.warn('fetchTokens failed', e);
        const cached = cacheGet('mons_tokens');
        if (cached){ renderTokens(cached); setServerStatus(false, 'Offline — showing cache'); }
        else { loading.textContent = 'Gagal memuat data.'; setServerStatus(false, 'Offline'); }
      }
    }

    function renderTokens(list){
      const loading = document.getElementById('tokensLoading');
      const table = document.getElementById('tokensTable');
      const tbody = document.getElementById('tokensTbody');
      tbody.innerHTML = '';
      if (!Array.isArray(list) || list.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-slate-400">Tidak ada token terindeks.</td></tr>';
      } else {
        for (const t of list){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="p-2 font-semibold">${t.tick}</td><td class="p-2">${t.maxSupply}</td><td class="p-2">${t.minted}</td><td class="p-2">${t.holdersCount}</td><td class="p-2"><a class=\"underline\" href=\"https://explorer.monad.xyz/address/${t.deployer}\" target=\"_blank\">${shortAddr(t.deployer)}</a></td>`;
          tbody.appendChild(tr);
        }
      }
      loading.style.display = 'none'; table.classList.remove('hidden');
    }

    function shortAddr(a){ if(!a) return '-'; return a.slice(0,6)+'…'+a.slice(-4); }

    // WebSocket (real-time)
    let ws;
    function connectWs(){
      try{
        const url = (WS_BASE.endsWith('/ws') ? WS_BASE : WS_BASE + '/ws');
        ws = new WebSocket(url);
      }catch(e){ console.warn('ws create failed', e); setServerStatus(false, 'WS failed'); return; }

      ws.onopen = ()=>{ console.log('ws open'); setServerStatus(true, 'WS connected'); };
      ws.onmessage = (m)=>{
        try{
          const d = JSON.parse(m.data);
          if (d.type === 'new_inscribe'){ prependInscribe(d.payload); }
          else if (d.type === 'tokens_snapshot'){ renderTokens(d.payload); cacheSet('mons_tokens', d.payload); }
        }catch(e){ console.warn('ws parse error', e); }
      };
      ws.onclose = (ev)=>{ console.log('ws closed', ev); setServerStatus(false, 'WS closed — reconnecting'); setTimeout(connectWs, 3000); };
      ws.onerror = (e)=>{ console.warn('ws err', e); ws.close(); };
    }

    function prependInscribe(evt){
      const el = document.createElement('div');
      el.className = 'p-2 border-b border-white/5';
      el.innerHTML = `<div><b>${evt.tick}</b> ${evt.operation} <span class=\"text-slate-400\">${evt.amount}</span> — <span class=\"text-xs text-slate-400\">${new Date(evt.time*1000).toLocaleString()}</span></div><div class=\"text-xs text-slate-400\">by ${shortAddr(evt.user)}</div>`;
      const box = document.getElementById('inscribes');
      box.prepend(el);
      while (box.children.length > 300) box.removeChild(box.lastChild);
    }

    // health ping
    async function pingHealth(){
      try{
        const res = await fetch(API_BASE + '/health');
        if (!res.ok) throw new Error('health HTTP ' + res.status);
        const j = await res.json();
        setServerStatus(true, 'Server OK · block ' + (j.block || 'n/a'));
      }catch(e){ console.warn('health err', e); setServerStatus(false, 'Server unreachable'); }
    }

    // UI events
    document.getElementById('refreshBtn').addEventListener('click', ()=>{ fetchTokens(); pingHealth(); });
    document.getElementById('clearCache').addEventListener('click', ()=>{ localStorage.removeItem('mons_tokens'); localStorage.removeItem('mons_lastSynced'); alert('Cache cleared'); fetchTokens(); });

    // initial
    (function init(){
      fetchTokens();
      connectWs();
      pingHealth();
      // poll health every 20s
      setInterval(pingHealth, 20000);
    })();
  </script>

  <!-- END frontend -->
</body>
</html>
