<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monscription Indexer — MONS (Monad Testnet)</title>
  <meta name="description" content="Indexer for Monscription tokens on Monad Testnet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#8b5cf6;--muted:rgba(255,255,255,0.65);}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:linear-gradient(180deg,#071024 0%, #071122 60%);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px}
    .wrap{width:100%;max-width:960px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    h1{font-size:20px;margin:0}
    .credit{font-size:12px;color:var(--muted)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);padding:20px;border-radius:12px;box-shadow:0 6px 30px rgba(3,8,23,0.6)}
    .controls{display:flex;gap:12px;margin-bottom:18px}
    input[type=text]{flex:1;padding:12px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;font-size:14px}
    button{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#06b6d4);color:white;font-weight:600;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:8px}
    .stat{display:flex;flex-direction:column;gap:6px}
    .stat .label{font-size:12px;color:var(--muted)}
    .stat .value{font-size:18px;font-weight:700}
    .progressBar{height:12px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden}
    .progressBar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#06b6d4);width:0%}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px 6px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    footer{margin-top:14px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    a.creditLink{color:var(--muted);text-decoration:none}
    .mintLink{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px}
    @media (max-width:880px){.grid{grid-template-columns:1fr;}
      .card{padding:14px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Monscription Indexer — Monad Testnet</h1>
        <div class="credit">Reads live data from contract <span class="small">0x07169f0F890C3595421512D98DC79b8bce6E5fA6</span></div>
      </div>
      <div style="text-align:right">
        <div class="small">Created by <a class="creditLink" href="https://x.com/ega_2ez4crypto" target="_blank">@ega_2ez4crypto</a></div>
        <div style="margin-top:6px"><a class="creditLink mintLink" href="https://mons-mon-20.vercel.app/" target="_blank">Mint →</a></div>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <input id="ticker" type="text" placeholder="Enter ticker (e.g. MONS)" value="MONS" />
        <button id="fetchBtn">Fetch</button>
        <button id="connectBtn">Connect Wallet</button>
      </div>

      <div id="report" class="grid">
        <div>
          <div class="card" style="margin-bottom:12px">
            <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
              <div>
                <div class="small">Token</div>
                <div id="out_ticker" class="value">—</div>
                <div class="small" id="deployer">Deployer: —</div>
              </div>
              <div style="min-width:160px">
                <div class="stat"><div class="label">Max Supply</div><div id="maxSupply" class="value">—</div></div>
                <div class="stat"><div class="label">Minted</div><div id="minted" class="value">—</div></div>
                <div style="margin-top:8px"><div class="label">Progress</div><div class="progressBar"><i id="progress" style="width:0%"></i></div><div class="small" id="percentText">—</div></div>
              </div>
            </div>
            <div style="margin-top:12px" class="small">Note: this contract is not an ERC20 standard — data is fetched using the contract's public read functions.</div>
          </div>

          <div class="card">
            <h3 style="margin:0 0 8px 0">Top Holders</h3>
            <div id="holdersArea" class="small">No data yet — click Fetch.</div>
          </div>
        </div>

        <aside>
          <div class="card">
            <div class="stat"><div class="label">Chain</div><div class="value">Monad Testnet (chainId: 10143)</div></div>
            <div style="height:12px"></div>
            <div class="stat"><div class="label">Inscription Counter</div><div id="inscriptions" class="value">—</div></div>
            <div style="height:8px"></div>
            <div class="stat"><div class="label">Holders Count</div><div id="holdersCount" class="value">—</div></div>
            <div style="height:8px"></div>
            <div class="stat"><div class="label">Limit Per Mint</div><div id="limitPerMint" class="value">—</div></div>
            <div style="height:8px"></div>
            <div class="stat"><div class="label">Last update</div><div id="lastUpdate" class="small">—</div></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3 style="margin:0 0 6px 0">Raw Data (quick)</h3>
            <table>
              <tr><th>Field</th><th>Value</th></tr>
              <tr><td>getTotalMinted</td><td id="raw_totalMinted">—</td></tr>
              <tr><td>getMintProgress</td><td id="raw_progress">—</td></tr>
              <tr><td>InscriptionCounter</td><td id="raw_insc">—</td></tr>
            </table>
          </div>
        </aside>
      </div>

      <footer>
        <div>.</div>
        <div class="small">Built for Monad RPC: <span class="small">https://testnet-rpc.monad.xyz</span></div>
      </footer>
    </div>
  </div>

<script>
(async function(){
  // Configuration
  const CONTRACT_ADDRESS = '0x07169f0F890C3595421512D98DC79b8bce6E5fA6';
  const RPC = 'https://testnet-rpc.monad.xyz';
  const CHAIN_ID = 10143;
  const ABI = /* ABI START */[
	{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
	{"anonymous":false,"inputs":[{"indexed":true,"internalType":"string","name":"tick","type":"string"},{"indexed":false,"internalType":"uint256","name":"maxSupply","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"limitPerMint","type":"uint256"},{"indexed":false,"internalType":"address","name":"deployer","type":"address"}],"name":"Deploy","type":"event"},
	{"inputs":[{"internalType":"string","name":"tick","type":"string"},{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"limitPerMint","type":"uint256"}],"name":"deployToken","outputs":[],"stateMutability":"payable","type":"function"},
	{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"string","name":"tick","type":"string"},{"indexed":false,"internalType":"string","name":"operation","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"data","type":"string"},{"indexed":false,"internalType":"uint256","name":"inscriptionNumber","type":"uint256"}],"name":"Inscribe","type":"event"},
	{"inputs":[{"internalType":"string","name":"tick","type":"string"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"payable","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"setDeployFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"string","name":"tick","type":"string"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
	{"stateMutability":"payable","type":"receive"},
	{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"string","name":"","type":"string"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"deployFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"tick","type":"string"}],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getHolders","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getHoldersCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getMintProgress","outputs":[{"internalType":"uint256","name":"minted","type":"uint256"},{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"percentage","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getTokenInfo","outputs":[{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"limitPerMint","type":"uint256"},{"internalType":"uint256","name":"minted","type":"uint256"},{"internalType":"address","name":"deployer","type":"address"},{"internalType":"uint256","name":"holdersCount","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getTotalMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"holders","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"inscriptionCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"address","name":"","type":"address"}],"name":"isHolder","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"mintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"tokens","outputs":[{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"limitPerMint","type":"uint256"},{"internalType":"address","name":"deployer","type":"address"},{"internalType":"bool","name":"exists","type":"bool"},{"internalType":"uint256","name":"deployedAt","type":"uint256"}],"stateMutability":"view","type":"function"},
	{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"totalMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]
  /* ABI END */;

  // helpers
  function fmtUnits(v){
    try{ if(typeof ethers.formatUnits === 'function') return ethers.formatUnits(v,18); }
    catch(e){}
    try{ return ethers.utils.formatUnits(v,18);}catch(e){return v.toString();}
  }
  function shortAddr(a){ return a.slice(0,6) + '...' + a.slice(-4); }

  // provider (read-only) + contract
  const rpcProvider = new ethers.providers.JsonRpcProvider(RPC);
  const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, rpcProvider);

  // UI refs
  const $ = id=>document.getElementById(id);
  const tickerInput = $('ticker');
  const fetchBtn = $('fetchBtn');
  const connectBtn = $('connectBtn');
  const outTicker = $('out_ticker');
  const deployerEl = $('deployer');
  const maxSupplyEl = $('maxSupply');
  const mintedEl = $('minted');
  const progressEl = $('progress');
  const percentText = $('percentText');
  const holdersArea = $('holdersArea');
  const inscriptionsEl = $('inscriptions');
  const holdersCountEl = $('holdersCount');
  const limitPerMintEl = $('limitPerMint');
  const lastUpdateEl = $('lastUpdate');
  const raw_totalMinted = $('raw_totalMinted');
  const raw_progress = $('raw_progress');
  const raw_insc = $('raw_insc');

  let signer=null; // optional

  async function fetchAll(tick){
    const t = (tick||'').toString();
    outTicker.textContent = t || '—';
    try{
      // parallel reads
      const [tokenInfo, mintProgress, totalMinted, holders, insCount] = await Promise.all([
        contract.getTokenInfo(t),
        contract.getMintProgress(t),
        // try both names just in case
        contract.getTotalMinted(t).catch(()=>contract.totalMinted(t)).catch(()=>ethers.BigNumber.from(0)),
        contract.getHolders(t).catch(()=>[]),
        contract.inscriptionCounter().catch(()=>ethers.BigNumber.from(0))
      ]);

      // tokenInfo: maxSupply, limitPerMint, minted, deployer, holdersCount
      const maxSupply = tokenInfo.maxSupply ?? tokenInfo[0] ?? ethers.BigNumber.from(0);
      const limitPerMint = tokenInfo.limitPerMint ?? tokenInfo[1] ?? ethers.BigNumber.from(0);
      const minted = tokenInfo.minted ?? tokenInfo[2] ?? totalMinted ?? ethers.BigNumber.from(0);
      const deployer = tokenInfo.deployer ?? tokenInfo[3] ?? '—';
      const holdersCount = tokenInfo.holdersCount ?? tokenInfo[4] ?? (holders.length || 0);

      // mintProgress returns (minted, maxSupply, percentage)
      const mp_minted = mintProgress.minted ?? mintProgress[0] ?? minted;
      const mp_max = mintProgress.maxSupply ?? mintProgress[1] ?? maxSupply;
      const mp_percentage = mintProgress.percentage ?? mintProgress[2] ?? 0;

      // format
      const maxSupplyF = fmtUnits(maxSupply);
      const mintedF = fmtUnits(mp_minted ?? minted);
      maxSupplyEl.textContent = Number(maxSupplyF).toLocaleString(undefined,{maximumFractionDigits:18});
      mintedEl.textContent = Number(mintedF).toLocaleString(undefined,{maximumFractionDigits:18});
      percentText.textContent = (Number(mp_percentage)/1).toFixed(2) + '%';
      progressEl.style.width = Math.min(100, Number(mp_percentage)||0) + '%';
      deployerEl.textContent = 'Deployer: ' + (deployer? shortAddr(deployer): '—');
      holdersCountEl.textContent = (holdersCount && holdersCount.toString)? holdersCount.toString(): String(holdersCount);
      limitPerMintEl.textContent = (limitPerMint && limitPerMint.toString)? fmtUnits(limitPerMint): String(limitPerMint);

      // raw displays
      raw_totalMinted.textContent = fmtUnits(totalMinted);
      raw_progress.textContent = `minted=${fmtUnits(mp_minted)} / max=${fmtUnits(mp_max)} (pct=${mp_percentage})`;
      raw_insc.textContent = insCount.toString();
      inscriptionsEl.textContent = insCount.toString();
      lastUpdateEl.textContent = new Date().toLocaleString();

      // holders list & top holders by balance
      if(Array.isArray(holders) && holders.length){
        holdersArea.innerHTML = '<table><tr><th>#</th><th>Address</th><th>Balance</th><th>% of minted</th></tr></table>';
        const tbl = holdersArea.querySelector('table');

        // fetch balances in parallel (limit concurrency to avoid node rate limits)
        const concurrency = 6;
        const results = [];
        for(let i=0;i<holders.length;i+=concurrency){
          const slice = holders.slice(i,i+concurrency);
          const calls = slice.map(a=>contract.getBalance(a,t).catch(()=>ethers.BigNumber.from(0)).then(b=>({address:a,balance:b})));
          const res = await Promise.all(calls);
          results.push(...res);
        }
        // compute percent relative to total minted (use totalMinted variable)
        let totalMintedBN = totalMinted ?? ethers.BigNumber.from(0);
        // sort desc
        results.sort((A,B)=>{ try{ return B.balance.sub(A.balance).toNumber(); }catch(e){return 0;} });
        // show top 10
        const top = results.slice(0,10);
        for(let i=0;i<top.length;i++){
          const r = top[i];
          const balF = fmtUnits(r.balance);
          const pct = (Number(fmtUnits(r.balance)) / Math.max(1, Number(fmtUnits(totalMintedBN))) ) * 100;
          const row = document.createElement('tr');
          row.innerHTML = `<td>${i+1}</td><td title="${r.address}">${shortAddr(r.address)}</td><td>${Number(balF).toLocaleString(undefined,{maximumFractionDigits:18})}</td><td>${pct.toFixed(4)}%</td>`;
          tbl.appendChild(row);
        }
        if(holders.length>10){
          const more = document.createElement('div'); more.className='small'; more.style.marginTop='8px'; more.textContent = `${holders.length - top.length} more holders not shown.`;
          holdersArea.appendChild(more);
        }
      } else {
        holdersArea.innerHTML = '<div class="small">No holders list returned by contract (or empty).</div>';
      }

    } catch(err){
      console.error(err);
      alert('Failed to fetch data — see console for details');
    }
  }

  // connect wallet (optional) - use if user wants to interact later
  connectBtn.addEventListener('click', async ()=>{
    if(window.ethereum){
      try{
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
        const network = await web3Provider.getNetwork();
        if(network.chainId !== CHAIN_ID){
          alert('Please switch wallet to Monad Testnet (chainId: '+CHAIN_ID+'). Read-only mode will still function.');
        }
        signer = web3Provider.getSigner();
        connectBtn.textContent = 'Wallet connected';
        connectBtn.disabled = true;
      }catch(e){console.error(e);alert('Wallet connection rejected')}
    } else alert('No wallet detected (Metamask). Read-only via RPC will still work.');
  });

  fetchBtn.addEventListener('click', ()=>{
    const t = tickerInput.value.trim();
    if(!t){alert('Please enter a ticker');return}
    fetchAll(t);
  });

  // auto fetch initial
  fetchAll(tickerInput.value.trim() || 'MONS');
})();
</script>
</body>
</html>
