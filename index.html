<!doctype html>
<html lang="en" class="antialiased">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monscription Indexer — MONS Viewer</title>

  <!-- Tailwind (cdn) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Ethers v6 UMD build (browser) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

  <style>
    /* small extra styling */
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-100">
  <main class="min-h-screen p-6 max-w-6xl mx-auto">
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">Monscription Indexer</h1>
        <p class="text-slate-400 mt-1">Enter a ticker (e.g. <strong>MONS</strong>) to view supply, holders, top-holders and mint progress.</p>
      </div>
      <div class="text-right">
        <a href="https://mons-mon-20.vercel.app/" target="_blank" class="text-sm px-3 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-md">Go to mint</a>
        <div class="text-xs text-slate-400 mt-1">Created by <a class="underline" href="https://x.com/ega_2ez4crypto" target="_blank">ega_2ez4crypto</a></div>
      </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div class="md:col-span-2 glass p-6 rounded-2xl shadow-lg">
        <label class="block text-sm text-slate-300 mb-2">Ticker</label>
        <div class="flex gap-3 items-center">
          <input id="ticker" class="flex-1 px-4 py-3 rounded-md bg-slate-800 border border-slate-700 outline-none" placeholder="Enter ticker (e.g. MONS)" value="MONS" />
          <button id="btnLookup" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 rounded-md font-semibold">Lookup</button>
          <button id="btnConnect" class="px-4 py-2 bg-sky-600 hover:bg-sky-500 rounded-md font-semibold">Connect Wallet</button>
        </div>

        <div id="status" class="mt-4 text-sm text-slate-400"></div>

        <div id="mainContent" class="mt-6 hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 bg-slate-800 rounded-xl">
              <div class="text-slate-400 text-sm">Max supply</div>
              <div id="maxSupply" class="text-2xl font-bold mt-1">—</div>
            </div>
            <div class="p-4 bg-slate-800 rounded-xl">
              <div class="text-slate-400 text-sm">Total minted</div>
              <div id="minted" class="text-2xl font-bold mt-1">—</div>
            </div>
            <div class="p-4 bg-slate-800 rounded-xl">
              <div class="text-slate-400 text-sm">Holders</div>
              <div id="holdersCount" class="text-2xl font-bold mt-1">—</div>
            </div>
          </div>

          <div class="mt-6">
            <div class="flex items-center justify-between">
              <div class="text-sm text-slate-300">Mint progress</div>
              <div id="percentLabel" class="text-sm text-slate-400">—</div>
            </div>
            <div class="w-full h-4 mt-2 bg-slate-700 rounded-full overflow-hidden">
              <div id="progressBar" class="h-4 rounded-full bg-emerald-500" style="width:0%"></div>
            </div>
          </div>

          <div class="mt-6 p-4 bg-slate-800 rounded-xl">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Top holders</h3>
              <div class="text-sm text-slate-400">Showing top <span id="topN">10</span> (by balance)</div>
            </div>

            <div class="mt-3 overflow-x-auto">
              <table class="w-full text-left">
                <thead class="text-slate-400 text-xs uppercase">
                  <tr>
                    <th class="py-2 pr-4">#</th>
                    <th class="py-2 pr-4">Address</th>
                    <th class="py-2 pr-4">Balance</th>
                    <th class="py-2 pr-4">Share</th>
                    <th class="py-2 pr-4">Actions</th>
                  </tr>
                </thead>
                <tbody id="topHoldersTable" class="align-top"></tbody>
              </table>
            </div>
          </div>

          <div class="mt-6 p-4 bg-slate-800 rounded-xl">
            <h3 class="text-lg font-semibold">Raw token info & actions</h3>
            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
              <pre id="rawInfo" class="p-3 bg-slate-900 rounded-md text-xs overflow-auto max-h-48"></pre>
              <div class="space-y-3">
                <button id="btnCopyRaw" class="w-full px-4 py-2 bg-slate-700 rounded-md">Copy raw JSON</button>
                <a id="mintLink" target="_blank" class="block w-full text-center px-4 py-2 bg-indigo-600 rounded-md hover:bg-indigo-500">Open mint page</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <aside class="glass p-6 rounded-2xl shadow-lg">
        <h3 class="text-lg font-semibold mb-3">Connection</h3>
        <div class="text-sm text-slate-400">RPC & chain</div>
        <div class="mt-2 text-xs bg-slate-900 p-3 rounded">
          <div><strong>Chain ID:</strong> 10143</div>
          <div class="mt-1"><strong>RPC:</strong> https://testnet-rpc.monad.xyz</div>
          <div class="mt-1"><strong>Contract:</strong> 0x07169f0F890C3595421512D98DC79b8bce6E5fA6</div>
        </div>

        <div class="mt-4">
          <h4 class="text-sm font-semibold">Notes</h4>
          <ul class="text-slate-400 text-sm mt-2 space-y-1">
            <li>- The indexer reads data directly from the Monscription contract (read-only).</li>
            <li>- Top holders computed from on-chain holder list (first N entries processed).</li>
            <li>- If holders list is large, the UI limits requests to avoid RPC throttling.</li>
          </ul>
        </div>

        <div class="mt-6 text-xs text-slate-400">
          <div>Language: English</div>
          <div class="mt-2">Credit: <a href="https://x.com/ega_2ez4crypto" target="_blank" class="underline">ega_2ez4crypto</a></div>
        </div>
      </aside>
    </section>

    <footer class="text-center text-slate-500 text-sm mt-6">
      Ready to release — copy this file to your hosting. If you want customization (dark theme, token logo, auto-refresh), tell me what to change.
    </footer>
  </main>

  <script>
    (async () => {
      // Configuration
      const RPC = "https://testnet-rpc.monad.xyz";
      const CHAIN_ID = 10143;
      const CONTRACT_ADDRESS = "0x07169f0F890C3595421512D98DC79b8bce6E5fA6";
      const MINT_LINK = "https://mons-mon-20.vercel.app/"; // as requested

      // ABI (from user)
      const ABI = [
        {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"string","name":"tick","type":"string"},{"indexed":false,"internalType":"uint256","name":"maxSupply","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"limitPerMint","type":"uint256"},{"indexed":false,"internalType":"address","name":"deployer","type":"address"}],"name":"Deploy","type":"event"},
        {"inputs":[{"internalType":"string","name":"tick","type":"string"},{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"limitPerMint","type":"uint256"}],"name":"deployToken","outputs":[],"stateMutability":"payable","type":"function"},
        {"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"string","name":"tick","type":"string"},{"indexed":false,"internalType":"string","name":"operation","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"data","type":"string"},{"indexed":false,"internalType":"uint256","name":"inscriptionNumber","type":"uint256"}],"name":"Inscribe","type":"event"},
        {"inputs":[{"internalType":"string","name":"tick","type":"string"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"payable","type":"function"},
        {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"setDeployFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"string","name":"tick","type":"string"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"stateMutability":"payable","type":"receive"},
        {"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"string","name":"","type":"string"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"deployFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"tick","type":"string"}],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getHolders","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getHoldersCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getMintProgress","outputs":[{"internalType":"uint256","name":"minted","type":"uint256"},{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"percentage","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getTokenInfo","outputs":[{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"limitPerMint","type":"uint256"},{"internalType":"uint256","name":"minted","type":"uint256"},{"internalType":"address","name":"deployer","type":"address"},{"internalType":"uint256","name":"holdersCount","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getTotalMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"holders","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"inscriptionCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"address","name":"","type":"address"}],"name":"isHolder","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"mintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"tokens","outputs":[{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"limitPerMint","type":"uint256"},{"internalType":"address","name":"deployer","type":"address"},{"internalType":"bool","name":"exists","type":"bool"},{"internalType":"uint256","name":"deployedAt","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"totalMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
      ];

      // DOM
      const el = s => document.querySelector(s);
      const status = el("#status");
      const btnLookup = el("#btnLookup");
      const inputTicker = el("#ticker");
      const mainContent = el("#mainContent");
      const maxSupplyEl = el("#maxSupply");
      const mintedEl = el("#minted");
      const holdersCountEl = el("#holdersCount");
      const progressBar = el("#progressBar");
      const percentLabel = el("#percentLabel");
      const topHoldersTable = el("#topHoldersTable");
      const rawInfoEl = el("#rawInfo");
      const btnCopyRaw = el("#btnCopyRaw");
      const mintLinkBtn = el("#mintLink");
      const topNEl = el("#topN");
      const btnConnect = el("#btnConnect");

      // Setup ethers provider & contract
      const provider = new ethers.providers.JsonRpcProvider(RPC, Number(CHAIN_ID));
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

      // Wallet connect (MetaMask) to allow copy-to-wallet or more features
      let walletSigner = null;
      async function connectWallet() {
        if (!window.ethereum) {
          alert("No injected wallet found (MetaMask). You can still use the viewer read-only.");
          return;
        }
        try {
          const providerWeb3 = new ethers.BrowserProvider(window.ethereum);
          await providerWeb3.send("eth_requestAccounts", []);
          walletSigner = await providerWeb3.getSigner();
          btnConnect.textContent = "Wallet connected";
          btnConnect.classList.remove("bg-sky-600");
          btnConnect.classList.add("bg-slate-600");
        } catch (err) {
          console.error(err);
          alert("Wallet connection failed.");
        }
      }

      btnConnect.addEventListener("click", connectWallet);

      function setStatus(text, error=false) {
        status.textContent = text;
        status.style.color = error ? "#f87171" : "";
      }

      // concurrency-limited map to avoid RPC flooding
      async function pMap(iterable, mapper, concurrency = 8) {
        const ret = [];
        const iterator = iterable[Symbol.iterator]();
        let active = 0;
        let done = false;

        return new Promise((resolve, reject) => {
          const next = async () => {
            if (done) return;
            const item = iterator.next();
            if (item.done) {
              done = true;
              if (active === 0) resolve(ret);
              return;
            }
            active++;
            try {
              const r = await mapper(item.value);
              ret.push(r);
            } catch (e) {
              reject(e);
              done = true;
              return;
            } finally {
              active--;
              next();
            }
          };
          // start initial
          for (let i = 0; i < concurrency; i++) next();
        });
      }

      // Format helpers
      function shortAddr(a) {
        return a ? (a.slice(0,6) + "..." + a.slice(-4)) : "";
      }
      function formatNumber(n) {
        try {
          if (typeof n === "string") n = BigInt(n);
          if (typeof n === "bigint") return n.toString();
          return String(n);
        } catch (e) {
          return String(n);
        }
      }

      async function fetchToken(tick) {
        setStatus("Fetching token info...");
        mainContent.classList.add("hidden");
        topHoldersTable.innerHTML = "";
        rawInfoEl.textContent = "";

        try {
          // getTokenInfo
          const info = await contract.getTokenInfo(tick);
          // info: { maxSupply, limitPerMint, minted, deployer, holdersCount }
          const maxSupply = BigInt(info.maxSupply.toString ? info.maxSupply.toString() : info.maxSupply);
          const minted = BigInt(info.minted.toString ? info.minted.toString() : info.minted);
          const holdersCount = BigInt(info.holdersCount.toString ? info.holdersCount.toString() : info.holdersCount);
          const limitPerMint = BigInt(info.limitPerMint.toString ? info.limitPerMint.toString() : info.limitPerMint);
          const deployer = info.deployer;

          // getMintProgress (some contracts provide percentage)
          let progress = { minted, maxSupply, percentage: 0n };
          try {
            const p = await contract.getMintProgress(tick);
            progress = {
              minted: BigInt(p.minted.toString ? p.minted.toString() : p.minted),
              maxSupply: BigInt(p.maxSupply.toString ? p.maxSupply.toString() : p.maxSupply),
              percentage: BigInt(p.percentage.toString ? p.percentage.toString() : p.percentage)
            };
          } catch (e) {
            // fallback to compute percentage
            if (maxSupply > 0n) {
              const perc = (minted * 100n) / maxSupply;
              progress = { minted, maxSupply, percentage: perc };
            }
          }

          // holders list (be careful if huge)
          setStatus("Fetching holders list (may take time for many holders)...");
          let holders = [];
          try {
            holders = await contract.getHolders(tick);
          } catch (e) {
            // fallback: try getHoldersCount and iterate holders mapping
            try {
              const count = Number(holdersCount);
              for (let i = 0; i < Math.min(count, 1000); i++) {
                const addr = await contract.holders(tick, i);
                holders.push(addr);
              }
            } catch (ee) {
              console.warn("Could not fetch holders listing by index", ee);
            }
          }

          // compute balances for each holder (limit how many we fetch)
          setStatus(`Fetching balances for ${holders.length} holders (limited/parallel)...`);
          const maxToProcess = Math.min(holders.length, 500); // safety guard (adjustable)
          const holdersToProcess = holders.slice(0, maxToProcess);

          // pMap concurrency to avoid throttling
          const results = await pMap(holdersToProcess, async (addr) => {
            const bal = await contract.getBalance(addr, tick);
            // convert to BigInt
            const b = BigInt(bal.toString ? bal.toString() : bal);
            return { address: addr, balance: b };
          }, 10);

          // if there are more holders not processed, mark them as zero or unknown
          // sort results by balance desc
          results.sort((a,b) => {
            if (a.balance > b.balance) return -1;
            if (a.balance < b.balance) return 1;
            return 0;
          });

          // compute top holders and share percentages
          const totalMinted = progress.minted || minted || BigInt(await contract.getTotalMinted(tick).then(r=>r.toString()).catch(()=> "0"));
          const totalMintedBig = BigInt(totalMinted);
          const topN = 10;
          topNEl.textContent = topN;

          // update UI
          maxSupplyEl.textContent = formatNumber(maxSupply);
          mintedEl.textContent = formatNumber(progress.minted ?? minted);
          holdersCountEl.textContent = formatNumber(holdersCount);
          const percent = Number(progress.percentage ?? ((progress.minted * 100n) / (progress.maxSupply || 1n)));
          percentLabel.textContent = percent + "%";
          progressBar.style.width = Math.min(100, percent) + "%";

          // fill top holders table
          topHoldersTable.innerHTML = "";
          const top = results.slice(0, topN);
          top.forEach((h, idx) => {
            const share = totalMintedBig > 0n ? Number((h.balance * 10000n) / totalMintedBig) / 100 : 0;
            const tr = document.createElement("tr");
            tr.className = "border-t border-slate-700";
            tr.innerHTML = `
              <td class="py-3 pr-4 align-top text-sm">${idx+1}</td>
              <td class="py-3 pr-4 align-top text-sm"><a href="#" class="underline small" data-addr="${h.address}">${shortAddr(h.address)}</a> <div class="text-xs text-slate-400">${h.address}</div></td>
              <td class="py-3 pr-4 align-top text-sm">${formatNumber(h.balance)}</td>
              <td class="py-3 pr-4 align-top text-sm">${share.toFixed(2)}%</td>
              <td class="py-3 pr-4 align-top text-sm">
                <button data-copy="${h.address}" class="px-2 py-1 bg-slate-700 rounded text-xs">Copy</button>
                <a href="#" data-explorer="${h.address}" class="ml-2 text-xs underline">View</a>
              </td>
            `;
            topHoldersTable.appendChild(tr);
          });

          // raw info
          const raw = {
            tick,
            contract: CONTRACT_ADDRESS,
            maxSupply: maxSupply.toString(),
            minted: progress.minted.toString(),
            percent: progress.percentage.toString(),
            limitPerMint: limitPerMint.toString(),
            deployer,
            holdersCount: holdersCount.toString(),
            holdersSample: holders.slice(0, 50)
          };
          rawInfoEl.textContent = JSON.stringify(raw, null, 2);

          // mint link
          mintLinkBtn.href = `${MINT_LINK}?tick=${encodeURIComponent(tick)}`;

          // wire copy buttons
          topHoldersTable.querySelectorAll("button[data-copy]").forEach(btn => {
            btn.addEventListener("click", async (ev) => {
              const addr = btn.getAttribute("data-copy");
              try {
                await navigator.clipboard.writeText(addr);
                btn.textContent = "Copied";
                setTimeout(()=> btn.textContent = "Copy", 1200);
              } catch(e) {
                alert("Copy failed, please copy manually: " + addr);
              }
            });
          });

          // explorer links: no standard explorer for monad testnet included - open a block explorer if exists
          topHoldersTable.querySelectorAll("a[data-explorer]").forEach(a => {
            a.addEventListener("click", (ev) => {
              ev.preventDefault();
              const addr = a.getAttribute("data-explorer");
              // If you have a Monad testnet explorer URL, replace below:
              const explorerUrl = `https://explorer.monad.xyz/address/${addr}`; // <- best-effort placeholder
              window.open(explorerUrl, "_blank");
            });
          });

          // show
          mainContent.classList.remove("hidden");
          setStatus("Token loaded successfully.");
        } catch (err) {
          console.error(err);
          setStatus("Failed to fetch token data. See console for details.", true);
          mainContent.classList.add("hidden");
        }
      }

      // Attach events
      btnLookup.addEventListener("click", () => {
        const tick = inputTicker.value.trim();
        if (!tick) {
          setStatus("Please enter a ticker.", true);
          return;
        }
        fetchToken(tick.toUpperCase());
      });

      // copy raw json
      btnCopyRaw.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(rawInfoEl.textContent);
          btnCopyRaw.textContent = "Copied";
          setTimeout(()=> btnCopyRaw.textContent = "Copy raw JSON", 1200);
        } catch (e) {
          alert("Failed copy.");
        }
      });

      // automatically load default ticker on page open
      setStatus("Ready. Enter a ticker and click Lookup.");
      // auto-run for MONS initially:
      setTimeout(()=> {
        const defaultTick = inputTicker.value.trim();
        if (defaultTick) fetchToken(defaultTick.toUpperCase());
      }, 400);

    })();
  </script>
</body>
</html>
