import { useState } from "react";
import { ethers } from "ethers";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";

const CONTRACT_ADDRESS = "0x07169f0F890C3595421512D98DC79b8bce6E5fA6";
const RPC_URL = "https://testnet-rpc.monad.xyz";
const ABI = [
  // hanya ambil function penting dari ABI untuk ringkas
  "function getTokenInfo(string tick) view returns(uint256 maxSupply, uint256 limitPerMint, uint256 minted, address deployer, uint256 holdersCount)",
  "function getMintProgress(string tick) view returns(uint256 minted, uint256 maxSupply, uint256 percentage)",
  "function getHolders(string tick) view returns(address[])"
];

export default function Indexer() {
  const [tick, setTick] = useState("");
  const [loading, setLoading] = useState(false);
  const [info, setInfo] = useState(null);
  const [error, setError] = useState(null);

  async function fetchData() {
    try {
      setLoading(true);
      setError(null);

      const provider = new ethers.JsonRpcProvider(RPC_URL);
      const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

      const [tokenInfo, mintProgress, holders] = await Promise.all([
        contract.getTokenInfo(tick),
        contract.getMintProgress(tick),
        contract.getHolders(tick)
      ]);

      setInfo({
        tick,
        maxSupply: tokenInfo.maxSupply.toString(),
        limitPerMint: tokenInfo.limitPerMint.toString(),
        minted: tokenInfo.minted.toString(),
        deployer: tokenInfo.deployer,
        holdersCount: tokenInfo.holdersCount.toString(),
        holders,
        progress: mintProgress.percentage.toString()
      });
    } catch (err) {
      console.error(err);
      setError("Token not found or RPC error");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-black to-gray-900 text-white flex flex-col items-center p-8">
      <h1 className="text-4xl font-bold mb-4">Monscription Indexer</h1>
      <p className="mb-6 text-gray-400">Simple indexer for Monscription (Monad Testnet)</p>

      <div className="flex gap-2 mb-6">
        <Input
          placeholder="Enter ticker e.g. MONS"
          value={tick}
          onChange={(e) => setTick(e.target.value)}
          className="w-64"
        />
        <Button onClick={fetchData} disabled={loading}>
          {loading ? "Loading..." : "Search"}
        </Button>
      </div>

      {error && <p className="text-red-500 mb-4">{error}</p>}

      {info && (
        <Card className="bg-gray-800 w-full max-w-2xl">
          <CardContent className="p-6">
            <h2 className="text-2xl font-semibold mb-4">Token: {info.tick}</h2>
            <ul className="space-y-2">
              <li><b>Max Supply:</b> {info.maxSupply}</li>
              <li><b>Minted:</b> {info.minted} ({info.progress}%)</li>
              <li><b>Limit per Mint:</b> {info.limitPerMint}</li>
              <li><b>Deployer:</b> {info.deployer}</li>
              <li><b>Holders Count:</b> {info.holdersCount}</li>
              <li className="truncate"><b>Sample Holders:</b> {info.holders.slice(0,5).join(", ")}</li>
            </ul>
          </CardContent>
        </Card>
      )}

      <footer className="mt-12 text-gray-500 text-sm">
        Created by <a href="https://x.com/ega_2ez4crypto" target="_blank" className="underline">@ega_2ez4crypto</a> Â·
        Mint here: <a href="https://mons-mon-20.vercel.app/" target="_blank" className="underline">mons-mon-20.vercel.app</a>
      </footer>
    </div>
  );
}
